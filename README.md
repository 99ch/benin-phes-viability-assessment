# Closed-Loop PHES Feasibility Assessment – Benin

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.10+](https://img.shields.io/badge/python-3.10+-blue.svg)](https://www.python.org/downloads/)

This repository contains data and scripts for evaluating the technical, economic, and
hydrological feasibility of PHES (Pumped Hydro Energy Storage) sites identified in the
Atacora region.

## Project Objectives

- **Site detection** from FABDEM digital elevation model (30 m).
- **Water balance modeling (2002-2023)** using CHIRPS and ERA5 datasets.
- **Monte Carlo simulation (10,000 iterations/site)** to estimate hydrological autonomy probability.
- **Multi-criteria ranking (AHP)** integrating economic, hydrological and environmental dimensions.

## Repository Structure

```
.
├── data/                       # Raw data (FABDEM, CHIRPS, ERA5, site sheets)
├── n10_e001/                   # Detailed exports for different storage levels
├── src/phes_assessment/        # Python code (ingestion, analysis, pipelines)
├── pyproject.toml              # Project dependencies and configuration
└── README.md                   # This file
```

## Installation

1. Create and activate a Python virtual environment (>=3.10).
2. Install base dependencies:

```bash
pip install -e .
```

3. For advanced geoprocessing tools (GeoPandas, WhiteboxTools, RichDEM):

```bash
pip install -e .[full]
```

> ℹ️ `SALib` is installed by default via `pip install -e .` as required for `hydro-sim --sensitivity-*`. However, **WhiteboxTools** is only provided by the `[full]` extra: install it before running `site-basins`, `climate-series` or `hydro-sim`, otherwise these commands will fail due to missing basin GeoJSON files.

## First Available Tool

The `phes-data` module (alias `phes_assessment.cli`) inventories locally
available datasets and verifies their temporal coverage.

Example run:

```bash
python -m phes_assessment.cli
```

or, after installation, simply:

```bash
phes-data
```

The command returns the number of detected rasters, start/end dates,
and projection/resolution metadata. If a column displays `-`,
verify that files (e.g., FABDEM) have been properly decompressed in
`data/`.

### Compare Catalog vs FABDEM Altitudes

A second command samples FABDEM altitudes at the coordinates of the 12
sites and compares the head calculated from the DEM with that published
in the catalog.

```bash
python -m phes_assessment.cli fabdem-sample --output results/fabdem_sites.csv
```

The displayed table details, for each reservoir pair, the catalog head,
the FABDEM-derived head, and the difference between them. The `--output`
option (optional) saves the complete altitude-enriched table to a CSV.

### Generate CHIRPS/ERA5 Climate Series

```bash
# full 2002-2023 period, CSV output by default
python -m phes_assessment.cli climate-series \
  --basins results/site_basins.geojson \
  --output results/climate_series.csv

# example: ERA5 only for 2008-2010 with 1.5 km buffers (radius ignored with --basins)
python -m phes_assessment.cli climate-series \
  --dataset era5 \
  --start-year 2008 --end-year 2010 \
  --buffer-meters 1500 \
  --basins results/site_basins.geojson \
  --output results/era5_2008_2010.parquet
```

The command:

- **requires** a basin GeoJSON (`--basins`) generated by `site-basins`
  and applies `all_touched=True` to include edge pixels (the
  `--buffer-meters` parameter is ignored when basins are provided);
- processes only CHIRPS (precipitation) and/or ERA5 (evapotranspiration) rasters
  within the requested time window and computes spatial average
  within each polygon (Rich progress bar displayed during processing);
- exports a `pair_identifier × date` table with `precip_mm` and `etp_mm` columns.
- explicitly fails if a month is missing (NaN) in aggregated series to avoid
  any implicit extrapolation.

Main parameters:

- `--dataset {both,chirps,era5}` to choose which source(s) to aggregate;
- `--start-year` and `--end-year` to bound the analysis (2002‑2023 by default);
- `--buffer-meters` to adjust the spatial radius (in meters) around each reservoir;
- `--sites` to point to a specific CSV if needed.
- `--basins` to provide a watershed GeoJSON generated by `site-basins` (the
  buffer radius is then ignored and only hydrological boundaries are used).

> ⚠️ `climate-series` now refuses to run without a `--basins` GeoJSON. Run
> `python -m phes_assessment.cli site-basins --output results/site_basins.geojson` before
> any aggregation and reuse this file for `climate-series` then `hydro-sim`.

For a **CHIRPS-only** or **ERA5-only** workflow (incremental diagnostics):

1. First run `climate-series --dataset chirps --output results/chirps_only.parquet --basins results/site_basins.geojson` to generate `precip_mm`.
2. Then run `climate-series --dataset era5 --output results/era5_only.parquet --basins results/site_basins.geojson` to obtain `etp_mm`.
3. Merge the two files on `pair_identifier` + `date` (e.g., via `pandas.merge`).
   The combined file must contain both columns to feed `hydro-sim`.

The output is written in the requested format: `.parquet` if an engine
(`pyarrow`/`fastparquet`) is available, otherwise CSV. By default, the
`results/climate_series.csv` file is generated.

### Prepare ERA5 Rasters (evapotranspiration)

The multiband GeoTIFFs used by `climate-series --dataset era5` can be
reconstructed from ERA5 reanalysis while preserving the full Atacora extent.
The `process_era5_standard_evapotranspiration.py` script automates
**downloading via Copernicus API** (cdsapi) and then NetCDF → GeoTIFF
conversion (1 file per year, 12 monthly bands in mm/month).

```bash
python process_era5_standard_evapotranspiration.py \
  --start-year 2002 --end-year 2023 \
  --output-dir data/era5 \
  --cache-dir data/era5_raw \
  --north 12.8 --south 6.0 --west -1.5 --east 3.5
```

Prerequisites:

- create the `~/.cdsapirc` file containing your Copernicus `url` and `key`;
- install the `cdsapi` dependency (already included in `pip install -e .`).

Each compressed GeoTIFF (`era5_<year>.tif`) preserves the original 0.25°
resolution and metadata per band (`YYYY-MM`). To "convert only" already
downloaded NetCDF files, add `--skip-download` and place your files in the
folder specified by `--cache-dir`.

> ℹ️ ERA5 "monthly averaged reanalysis" fields return average daily fluxes
> in meters of water per day. The script therefore converts values to
> **mm/month** via `abs(pev) × nb_days × 1000`, which corresponds to the
> expected ranges (50‑200 mm/month over Atacora).

### Check Dataset Completeness

The `data-qa` command performs a quick diagnostic on CHIRPS, ERA5, and FABDEM
folders: actual vs expected temporal coverage, missing months/years,
potential duplicates, and FABDEM extent relative to site coordinates.

```bash
python -m phes_assessment.cli data-qa --start-year 2002 --end-year 2023
```

Useful options: `--sites` to use a specific CSV (extent verification),
`--start-year` / `--end-year` to adjust the expected window. The output
displays a summary table facilitating checks before feeding the pipelines.
Re-run `data-qa` after decompression to confirm that no `.tif.gz` remains
and that temporal coverage is complete.

### Simulate Stochastic Water Balance

Once the climate series are available, the `hydro-sim` command runs a Monte Carlo
experiment (currently **10,000 iterations per site**) that samples runoff,
infiltration, evaporation and leakage coefficients while enforcing strict mass
conservation (runoff + infiltration ≤ 1). The outputs include the annual balance
distribution, the probability of a positive balance (>0), and dry-season
diagnostics (median and P90 deficit → required top-up volume).

```bash
python -m phes_assessment.cli hydro-sim \
  --climate results/climate_series.csv \
    --basins results/site_basins.geojson \
    --iterations 10000 \
  --output results/hydrology_summary.parquet
```

Add `--basins results/site_basins.geojson` so the model uses watershed areas
from `site-basins` instead of reservoir surfaces.

The summary table lists, for each site, the annual median/P10/P90, the
probability that storage stays positive, the probability that storage remains
strictly positive **every dry-season month** (intra-season trajectory), the dry
season median balance, and the dry season P90 deficit (top-up volume computed
from the minimum storage reached). Exports default to Parquet via `pyarrow` and
fall back to CSV only if the Parquet engine is missing.

#### Global sensitivity analysis (Sobol/Morris)

The `--sensitivity-method {sobol|morris}` option triggers a SALib global
analysis over four factors (runoff, infiltration, ET multiplier, leakage). The
number of samples (`--sensitivity-samples`) and the response metric
(`median_balance`, `prob_positive`, `dry_median_balance`, `dry_p90_deficit`) are
fully configurable. Results are written to a `*_sensitivity.parquet` (or CSV)
file that can be fed into robustness assessments.

```bash
python -m phes_assessment.cli hydro-sim \
  --climate results/climate_series.csv \
  --basins results/site_basins.geojson \
  --iterations 10000 --seed 42 \
  --sensitivity-method sobol \
  --sensitivity-output results/hydrology_sensitivity.parquet \
  --sensitivity-metric median_balance
```

### Rank Sites via AHP

Economic classes (A → E) provided in `n10_e001_12_sites_complete.csv`
follow the Stocks et al. (2021) methodology: class A is most attractive
(low specific costs), class E most expensive. The `ahp-rank` command uses
**directly** this A→E hierarchy as economic criterion (no LCOS recalculation)
and combines it with hydrological diagnostics from `hydro-sim` plus some
infrastructure indicators (head, separation, slope, water/rock ratio).

```bash
python -m phes_assessment.cli ahp-rank \
    --hydrology-summary results/hydrology_summary.parquet \
    --output results/ahp_rankings.parquet \
    --economic-weight 0.45 --hydrology-weight 0.4 --infrastructure-weight 0.15
```

These weights can be defined in a JSON/YAML file and injected via
`--weights-config`:

```json
{
  "economic_weight": 0.5,
  "hydrology_weight": 0.35,
  "infrastructure_weight": 0.15
}
```

```bash
python -m phes_assessment.cli ahp-rank \
    --hydrology-summary results/hydrology_summary.parquet \
    --weights-config configs/ahp_weights.json
```

Under the hood:

- the economic criterion corresponds to class A→E (increasing order of
  Stocks et al., 2021 multipliers);
- probabilities `prob_positive_annual_balance` and
  `dry_season_prob_positive` serve the hydrological criterion;
- `Head (m)`, `Separation (km)`, `Slope (%)` and `Combined water to rock ratio`
  provide an infrastructure score.

The export (CSV or Parquet) contains sub-scores and final rank for audit
or integration into a broader multi-criteria matrix.

### Generate Article Figures

The `article-figures` command produces all charts cited in the manuscript
(algorithm flowchart, climate cycles, AHP weights, Monte Carlo comparison, heatmap)
in high-resolution PNG format (300 dpi).

```bash
python -m phes_assessment.cli article-figures \
  --climate results/climate_series.csv \
  --summary results/hydrology_summary.parquet \
  --ahp-rankings results/ahp_rankings.parquet \
  --figure-dir results/figures \
  --deterministic results/hydrology_deterministic_reference.csv
```

Notable options:

- `--deterministic`: CSV/Parquet file containing deterministic balances (annual
  median and dry season P10) to generate **Figure 7b** (bar chart).
  If omitted, this figure uses `hydrology_summary.parquet` directly.
- `--figure7-pair`: identifier of the site used for local climate cycle (default
  `n10_e001_RES31412 & n10_e001_RES31520`).

Files produced in `results/figures/`:

- `figure01_algorithme.png`: PHES site identification flowchart.
- `figure02_cycle_climatique.png`: national average seasonal cycle (CHIRPS+ERA5).
- `figure03_ahp_poids.png`: main criteria and AHP sub-criteria weights.
- `figure07_cycle_site_res31412.png`: reference site local climate cycle.
- `figure07b_bilan_deterministe.png`: bar chart comparing annual median
  and dry season deficit (P10) for each site.
- `figure08_monte_carlo.png`: P10-P90 distributions of annual balances.
- `figure09_ahp_heatmap.png`: heatmap of AHP scores and normalized sub-criteria
  (16×9 in, enlarged typography for DOCX/PDF export).

These files are directly used in `ARTICLE_COMPLET_FR.md` via Markdown references
and can be updated by re-running the command after any data or parameter changes.

#### Scientific Parameter References

| Parameter                                           | Default value                | Source / justification                                                                                                                                  |
| --------------------------------------------------- | ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Runoff coefficient (`runoff_min`–`runoff_max`)      | 0.30 → 0.80                  | Descroix et al. (2010) document the “Sahelian paradox” with runoff peaks up to 0.8 in Beninese basins; aligned with Donga/Koupendri field observations. |
| Infiltration coefficient (`infiltration_min`–`max`) | 0.05 → 0.25                  | Kamagaté et al. (2007) report 5–24% direct infiltration; Azuka & Igué (2020) confirm similar inter-site variability across agricultural settings.       |
| Initial storage (`initial_storage_fraction`)        | 60% of reservoir capacity    | PNNL recommendation (Pracheil et al., 2025) for preliminary closed-loop PHES studies to ensure the starting dry season is covered.                      |
| ET multiplier (`evap_mean`, `evap_std`, bounds)     | 1.0 ± 0.1 clipped to 0.5–1.5 | Local ERA5 uncertainty (Hersbach et al., 2020) combined with the ±20% margins used by Simon et al. (2023) in PHES life-cycle analyses.                  |
| Linear leakage (`leakage_min`–`leakage_max`)        | 0.05 → 0.20% of stock/month  | Range derived from DOE/PNNL assessments (Pracheil et al., 2025; Simon et al., 2023) covering liner and foundation losses during feasibility studies.    |

These sources are detailed in `docs/methodology.md` and the associated RDF references (`Close_loop_Ben.rdf`).

### Export Site Masks to GeoJSON

For GIS visualization or any post-processing, you can export the circular buffers
generated around each reservoir pair directly to GeoJSON:

```bash
python -m phes_assessment.cli site-masks --output results/site_masks.geojson
```

This command creates a `FeatureCollection` with one polygon per `pair_identifier`
along with metadata describing the applied radius and the EPSG used for the buffer
construction.

Available options:

- `--sites` to point to an alternative CSV;
- `--buffer-meters` to redefine the radius (meters) applied around each
  reservoir;
- `--utm-epsg` to pick the EPSG code for the temporary metric projection;
- `--output` to define the target GeoJSON file (default `results/site_masks.geojson`).

### Derive Watersheds from FABDEM

The hydrology workflow now relies on the actual contributing area of each reservoir pair
instead of simple buffers. The `site-basins` command calls WhiteboxTools to fill FABDEM
depressions, compute D8 flow directions, and extract the upstream basin associated with the
`Upper` point of each site. The output GeoJSON stores the polygons, their area in km², and
the processing metadata.

```bash
python -m phes_assessment.cli site-basins \
    --output results/site_basins.geojson \
    --dem-margin-km 15
```

Practical tips:

- install WhiteboxTools via `pip install -e .[full]` or `pip install whitebox` before
  running the command;
- use `--work-dir tmp/whitebox` if you want to keep the intermediate rasters for GIS
  inspection;
- the GeoJSON file can be directly used by other commands (`--basins`).

### Complete Pipeline (recommended order)

1. **Prepare climate rasters**

   - ERA5: `python process_era5_standard_evapotranspiration.py --start-year 2002 --end-year 2023 --output-dir data/era5` (requires `cdsapi` + `~/.cdsapirc`).
   - CHIRPS: `.tif` files must be decompressed in `data/chirps/`. If you have `.tif.gz` files, use:

     ```bash
     gunzip -f data/chirps/*.tif.gz
     ```

     To clean up residual files (`.gz.1`, `.gz.2`, etc.):

     ```bash
     rm -f data/chirps/*.gz*
     ```

2. **Derive basins**: `python -m phes_assessment.cli site-basins --output results/site_basins.geojson` (WhiteboxTools required).
3. **Climate aggregations**: `python -m phes_assessment.cli climate-series --dataset both --basins results/site_basins.geojson --output results/climate_series.parquet` (repeat per sub-period if needed).
4. **Hydrological simulation**: `python -m phes_assessment.cli hydro-sim --climate results/climate_series.parquet --basins results/site_basins.geojson --output results/hydrology_summary.parquet`.
5. **AHP ranking**: `python -m phes_assessment.cli ahp-rank --hydrology-summary results/hydrology_summary.parquet --output results/ahp_rankings.parquet`.

Each step is traceable via `docs/methodology.md`, and files generated in `results/`
document pipeline reproducibility.

## Published Artifacts (`results/`)

The following outputs are already included in the repository to facilitate review and
reproduction:

- `results/site_basins.geojson`: watersheds derived from FABDEM/WhiteboxTools (15 km margin).
- `results/site_masks.geojson`: 500 m circular buffers provided as cartographic reference.
- `results/climate_series.csv`: CHIRPS+ERA5 series aggregated (2002–2023) over the delineated basins.
- `results/hydrology_summary.parquet` (+ `.csv`): Monte Carlo synthesis (10k draws, seed 42, run on 23 Nov 2025) with the annual and dry-season metrics that retain explicit mass conservation (`dry_season_prob_positive`, `dry_season_prob_storage_positive`). Updated medians range from -14.02 to +4.63 GL/year (global median = -0.23 GL) and only four sites exceed a 50% probability of a positive annual balance.
- `results/hydrology_sensitivity.parquet` and `results/hydrology_summary_sobol.parquet`: SALib indices (Sobol/Morris) referenced in Section 3.3 of the article. The latest Saltelli indices show that runoff explains ≈81% of the annual variance, leakage ≈14%, infiltration ≈5%, and evapotranspiration <0.1%, directly guiding field measurement priorities.
- `results/ahp_rankings.parquet`: weighted ranking of the 12 sites (default weights 0.4/0.3/0.2/0.1).
- `results/hydrology_deterministic_reference.csv`: annual medians and dry-season P10 deficits used for Figure 7b (deterministic reference).
- `results/figures/*.png`: high-resolution charts (300 dpi) generated by `article-figures` and embedded in the manuscript (flowchart, climate cycles, AHP heatmap, Monte Carlo distributions).

Each file is regenerable by following the sequence above. Reviewers can
thus directly compare manuscript figures (Tables 3–4) with provided exports.

### Hydrologic snapshot (23 November 2025 run)

| Priority site | Annual median (GL/year) | P(>0) (%) | Dry season P10 (GL) |
| ------------- | ----------------------- | --------- | ------------------- |
| RES18951      | +4.63                   | 100.0     | -1.63               |
| RES11634      | +3.29                   | 100.0     | -0.63               |
| RES35193      | +1.94                   | 100.0     | -0.68               |
| RES15127      | +1.65                   | 100.0     | -0.53               |

The remaining eight sites keep negative medians (-0.20 to -14.02 GL/year) and their probability of annual autonomy
remains zero. Every site shows `dry_season_prob_positive < 0.1%`, so the top-up volumes listed above (and in Table 4 of
the article) must be incorporated into any operational scenario.

## Methodology and Scientific References

- **CHIRPS** and **ERA5** series used by `climate-series` are justified by
  Funk et al. (2015) work on tropical extremes monitoring and Hersbach et al. (2020)
  regarding ERA5 reanalysis.
- Mask generation and elevation sampling rely on the **FABDEM** DEM (Hawker et al., 2022),
  which removes vegetation/building artifacts—essential to estimate heads correctly.
- Site selection and multi-criteria weighting follow the _Global Atlas of Closed-Loop PHES_
  (Stocks et al., 2021) and the GIS+AHP workflow assessed by Lopez et al. (2024) for Benin.
- The runoff/infiltration ranges and the “Sahelian paradox” diagnostic used in `hydro-sim`
  stem from Kamagaté et al. (2007), Azuka & Igué (2020), and Descroix et al. (2010) on nearby
  basins (Donga, Koupendri, West Sahel).
- The project’s energy QA and climate-risk sections build on the regional analyses of Mensah
  et al. (2023) plus the environmental/LCA assessments of Simon et al. (2023) and Pracheil et
  al. (2025) to place PHES sites within national pathways.

A detailed mapping table between each CLI module and cited references is
available in `docs/methodology.md`.

## Next Steps

- Industrialize the test suite (synthetic dataset + `pytest`) to validate mass conservation, dry-season metrics, and RNG independence.
- Add orchestration (Snakemake/Prefect) linking `process_era5_standard_evapotranspiration.py`, `site-basins`, `climate-series`, `hydro-sim`, and `ahp-rank`.
- Extend QA (`data-qa`) to automatically flag compressed CHIRPS files, suggest decompression commands, and verify GeoJSON completeness.
